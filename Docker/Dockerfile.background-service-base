# Base Image for SCLib Background Service
# Contains system packages, Python dependencies, and OpenVisus
# This base image is built separately and cached for faster builds
# Matches the configuration from Dockerfile.ag-explorer-bg-service-base for OpenVisus compatibility

FROM ubuntu:24.04

# Build arguments
ARG D_GIT_TOKEN
ARG INSTALL_HOME=/home/ViSOAR

# Environment Variables
ENV DEBIAN_FRONTEND=noninteractive \
    TZ=America/Chicago \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONPATH=/app:/app/scientistCloudLib:${INSTALL_HOME}/VisoarAgExplorer \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# Set work directory
WORKDIR /app

# Set timezone and install system dependencies (matching ag-explorer-bg-service-base)
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && \
    echo $TZ > /etc/timezone && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        # Core system packages
        git \
        curl \
        tar \
        gzip \
        unzip \
        sshpass \
        rclone \
        rsync \
        p7zip-full \
        # Python and development (using python3.12 like the old Dockerfile)
        python3.12 \
        python3-pip \
        python3-dev \
        build-essential \
        cmake \
        # Image processing dependencies
        zlib1g \
        zlib1g-dev \
        libjpeg-dev \
        libimage-exiftool-perl \
        libzbar0 \
        libnss3 \
        libcairo2-dev \
        # Scientific computing
        libhdf5-serial-dev \
        netcdf-bin \
        libnetcdf-dev \
        # PyQt5 system packages (for Python 3.12 compatibility)
        python3-pyqt5 \
        # Build tools
        patchelf \
        libssl-dev \
        libffi-dev \
        pkg-config \
        # XML processing libraries for lxml
        libxml2-dev \
        libxslt1-dev \
        # Additional dependencies for large-image and rasterio
        libgdal-dev \
        gdal-bin \
        libproj-dev \
        libgeos-dev \
        libtiff-dev \
        libwebp-dev \
        libopenjp2-7-dev \
        # Spatial database support
        libspatialite-dev \
        # Process management
        procps \
        # Note: python3-opencv removed to avoid conflicts with pip opencv
    && ln -s -f /usr/bin/python3.12 /usr/bin/python3 \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements first for better Docker layer caching
COPY SCLib_JobProcessing/requirements_fastapi.txt /app/requirements_fastapi.txt
COPY SCLib_JobProcessing/requirements.txt /app/requirements.txt
COPY SCLib_JobProcessing/requirements_conversion.txt /app/requirements_conversion.txt

# Install Python dependencies
# Use --break-system-packages flag (required for Ubuntu 24.04 with system Python)
# Install all requirements files to ensure all dependencies are available
# Note: Install GDAL first (specific version) before rasterio for compatibility
# Use --ignore-installed for packages that conflict with system packages (like numpy)
RUN python3 -m pip install --no-cache-dir --break-system-packages -r requirements_fastapi.txt && \
    python3 -m pip install --no-cache-dir --break-system-packages -r requirements.txt && \
    # Install GDAL first (compatible with libgdal 3.8.4)
    python3 -m pip install --no-cache-dir --break-system-packages "gdal==3.8.4" && \
    # Then install conversion requirements (which includes rasterio and large-image)
    # Use --ignore-installed to handle conflicts with system-installed packages like numpy
    # This tells pip to ignore already-installed packages and install/upgrade as needed
    python3 -m pip install --no-cache-dir --break-system-packages --ignore-installed -r requirements_conversion.txt

# Install Panel ecosystem first (may be needed for OpenVisus to configure properly)
RUN python3 -m pip install --no-cache-dir --break-system-packages \
        param>=2.0.0 \
        panel>=1.0.0 \
        holoviews>=1.16.0 \
        bokeh==3.8.0 \
        pymap3d
        
# Copy OpenVisus requirements file directly (simpler than /tmp/requirements/)
# Build context is .. (scientistCloudLib), so path is relative to that
COPY SCLib_JobProcessing/Docker/requirements/ubuntu-python310-requirements.txt /tmp/openvisus_requirements.txt

# Install OpenVisus (required for TIFF to IDX conversions)
RUN echo "=========================================" && \
    echo "Installing OpenVisus..." && \
    echo "Requirements file contents:" && \
    cat /tmp/openvisus_requirements.txt && \
    echo "=========================================" && \
    echo "Python version:" && python3 --version && \
    echo "pip version:" && python3 -m pip --version && \
    echo "=========================================" && \
    python3 -m pip install --no-cache-dir --break-system-packages -r /tmp/openvisus_requirements.txt || \
    (echo "❌ Pip install failed!" && \
     echo "Trying to install packages individually..." && \
     python3 -m pip install --no-cache-dir --break-system-packages OpenVisus==2.2.141 || \
     (echo "❌ OpenVisus==2.2.141 failed, trying without version..." && \
      python3 -m pip install --no-cache-dir --break-system-packages OpenVisus || \
      (echo "❌ All OpenVisus installation attempts failed!" && exit 1))) && \
    echo "=========================================" && \
    echo "Checking installed OpenVisus packages..." && \
    python3 -m pip list | grep -i openvisus || echo "No OpenVisus packages found!" && \
    echo "=========================================" && \
    echo "Verifying OpenVisus installation..." && \
    python3 -c "import OpenVisus; print('✅ OpenVisus base module imported successfully')" || \
    (echo "❌ Failed to import OpenVisus after installation!" && \
     echo "Python version:" && python3 --version && \
     echo "Python path:" && python3 -c "import sys; print('\n'.join(sys.path))" && \
     echo "Installed packages:" && python3 -m pip list | grep -i openvisus && \
     echo "Checking if OpenVisus files exist:" && \
     find /usr -name "*OpenVisus*" 2>/dev/null | head -10 || echo "No OpenVisus files found" && \
     exit 1) && \
    # Configure OpenVisus - this may fail but we continue
    CODE_SIGN=$(which codesign 2>/dev/null || echo "") python3 -m OpenVisus configure || echo "⚠️  OpenVisus configure failed, but continuing..."

# Verify OpenVisus installation - check if base module is available (required for all conversions)
# Fail the build if OpenVisus base module is not available
RUN python3 -c "import OpenVisus; print('✅ OpenVisus base module is available')" || \
    (echo "❌ ERROR: OpenVisus base module is not available!" && \
     echo "The OpenVisus installation failed. This is required for conversions." && \
     echo "Checking pip list..." && \
     pip list | grep -i openvisus || echo "No OpenVisus packages found in pip list" && \
     exit 1)

# Check if VisusKernelPy is available (native extension)
# This is a warning, not a fatal error, as some conversions may work without it
RUN python3 -c "from OpenVisus import VisusKernelPy; print('✅ OpenVisus.VisusKernelPy imported successfully')" || \
    (echo "⚠️  WARNING: OpenVisus.VisusKernelPy import failed!" && \
     echo "OpenVisus base module is available, but native extension may not be built." && \
     echo "TIFF conversions using OpenVisus may fail, but other conversions will work." && \
     echo "This is a known issue on some platforms - continuing build...")

# Create necessary directories
RUN mkdir -p /app/logs \
    /app/config \
    /mnt/visus_datasets/upload \
    /mnt/visus_datasets/converted \
    /mnt/visus_datasets/sync \
    /mnt/visus_datasets/tmp

# Use www-data user/group to match PHP/Apache service permissions
# This ensures files created by PHP (www-data) can be accessed by the background service
# Note: www-data user already exists in Ubuntu base image
RUN chown -R www-data:www-data /app /mnt/visus_datasets

# Clone VisoarAgExplorer repository (contains slampy module needed for RGB DRONE and MapIR DRONE conversions)
# Use token if provided, otherwise try public clone
RUN mkdir -p ${INSTALL_HOME} && \
    if [ -n "$D_GIT_TOKEN" ]; then \
        git clone -b dataportal https://${D_GIT_TOKEN}@github.com/sci-visus/VisoarAgExplorer.git ${INSTALL_HOME}/VisoarAgExplorer || \
        git clone -b dataportal https://github.com/sci-visus/VisoarAgExplorer.git ${INSTALL_HOME}/VisoarAgExplorer; \
    else \
        git clone -b dataportal https://github.com/sci-visus/VisoarAgExplorer.git ${INSTALL_HOME}/VisoarAgExplorer || \
        echo "Warning: Could not clone VisoarAgExplorer. slampy may not be available."; \
    fi && \
    chown -R www-data:www-data ${INSTALL_HOME}

