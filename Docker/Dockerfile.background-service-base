# Base Image for SCLib Background Service
# Contains system packages, Python dependencies, and OpenVisus
# This base image is built separately and cached for faster builds

FROM python:3.11-slim

# Build arguments
ARG D_GIT_TOKEN
ARG INSTALL_HOME=/home/ViSOAR

# Set environment variables
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONPATH=/app:/app/scientistCloudLib:${INSTALL_HOME}/VisoarAgExplorer \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# Set work directory
WORKDIR /app

# Install system dependencies (including build tools for OpenVisus and image processing)
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    procps \
    build-essential \
    cmake \
    python3-dev \
    libjpeg-dev \
    libpng-dev \
    zlib1g-dev \
    libssl-dev \
    pkg-config \
    patchelf \
    # Git for cloning repositories (VisoarAgExplorer for slampy)
    git \
    # Additional libraries for rasterio and image processing
    libgdal-dev \
    gdal-bin \
    libproj-dev \
    libgeos-dev \
    libtiff-dev \
    libwebp-dev \
    libopenjp2-7-dev \
    # Scientific computing libraries (HDF5, NetCDF)
    libhdf5-serial-dev \
    netcdf-bin \
    libnetcdf-dev \
    # Cairo for matplotlib and plotting
    libcairo2-dev \
    # Additional build dependencies
    libffi-dev \
    # XML processing libraries (for lxml and other XML parsers)
    libxml2-dev \
    libxslt1-dev \
    # Spatial database support
    libspatialite-dev \
    # File operations utilities
    rclone \
    rsync \
    p7zip-full \
    unzip \
    # SSH operations
    sshpass \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements first for better Docker layer caching
COPY SCLib_JobProcessing/requirements_fastapi.txt /app/requirements_fastapi.txt
COPY SCLib_JobProcessing/requirements.txt /app/requirements.txt
COPY SCLib_JobProcessing/requirements_conversion.txt /app/requirements_conversion.txt

# Install Python dependencies
# Install all requirements files to ensure all dependencies are available
# Note: Install GDAL first (specific version) before rasterio for compatibility
RUN pip install --no-cache-dir -r requirements_fastapi.txt && \
    pip install --no-cache-dir -r requirements.txt && \
    # Install GDAL first (compatible with libgdal 3.8.4)
    pip install --no-cache-dir "gdal==3.8.4" && \
    # Then install conversion requirements (which includes rasterio and large-image)
    pip install --no-cache-dir -r requirements_conversion.txt

# Install OpenVisus (required for TIFF to IDX conversions)
# This is the heavy part that we want to cache in the base image
# Follow the pattern from ag-explorer-base: install Panel ecosystem first, then OpenVisus
# The Panel ecosystem packages may be needed for OpenVisus to configure properly
RUN pip install --no-cache-dir \
        param>=2.0.0 \
        panel>=1.0.0 \
        holoviews>=1.16.0 \
        bokeh==3.8.0

# Now install OpenVisus (uninstall any existing versions first)
# Using version 2.2.135 to match Dockerfile.ag-explorer-base (background service uses this version)
RUN pip uninstall -y OpenVisus OpenVisusNoGui openvisuspy || true && \
    pip install --no-cache-dir OpenVisus==2.2.135 && \
    pip install --no-cache-dir openvisuspy && \
    # Configure OpenVisus - this may fail but we continue
    CODE_SIGN=$(which codesign 2>/dev/null || echo "") python3 -m OpenVisus configure || true

# Verify OpenVisus installation - warn if VisusKernelPy is not available
# Note: OpenVisus native extension may not be available on all platforms
# This is a warning, not a fatal error, so the build can continue
# TIFF conversions that don't require OpenVisus will still work
RUN python3 -c "import OpenVisus; from OpenVisus import VisusKernelPy; print('✅ OpenVisus.VisusKernelPy imported successfully')" || \
    (echo "⚠️  WARNING: OpenVisus.VisusKernelPy import failed!" && \
     echo "OpenVisus base module is available, but native extension may not be built." && \
     echo "TIFF conversions using OpenVisus may fail, but other conversions will work." && \
     echo "This is a known issue on some platforms - continuing build..." && \
     python3 -c "import OpenVisus; print('OpenVisus base module is available')" || true)

# Create necessary directories
RUN mkdir -p /app/logs \
    /app/config \
    /mnt/visus_datasets/upload \
    /mnt/visus_datasets/converted \
    /mnt/visus_datasets/sync \
    /mnt/visus_datasets/tmp

# Create a non-root user for security
# Note: Don't switch to app user here - let the service Dockerfile do it after setup
RUN useradd --create-home --shell /bin/bash app && \
    chown -R app:app /app /mnt/visus_datasets

# Clone VisoarAgExplorer repository (contains slampy module needed for RGB DRONE and MapIR DRONE conversions)
# Use token if provided, otherwise try public clone
# Do this after creating the app user so we can set ownership
RUN mkdir -p ${INSTALL_HOME} && \
    if [ -n "$D_GIT_TOKEN" ]; then \
        git clone -b dataportal https://${D_GIT_TOKEN}@github.com/sci-visus/VisoarAgExplorer.git ${INSTALL_HOME}/VisoarAgExplorer || \
        git clone -b dataportal https://github.com/sci-visus/VisoarAgExplorer.git ${INSTALL_HOME}/VisoarAgExplorer; \
    else \
        git clone -b dataportal https://github.com/sci-visus/VisoarAgExplorer.git ${INSTALL_HOME}/VisoarAgExplorer || \
        echo "Warning: Could not clone VisoarAgExplorer. slampy may not be available."; \
    fi && \
    chown -R app:app ${INSTALL_HOME}

